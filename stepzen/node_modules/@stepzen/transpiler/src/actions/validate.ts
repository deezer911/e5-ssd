import {buildASTSchema, DocumentNode, parse, print} from 'graphql'
import * as fs from 'fs-extra'
import * as os from 'os'
import * as path from 'path'

import ensureQueryAndMutationTypes from '../utils/ensure-query-and-mutation-types'
import {EXPERIMENTAL_EXTENSIONS} from '../utils/constants'
import validators from '../validators'

export default (
  source: string,
  options: {
    extensions: string
  } = {
    extensions: '',
  },
) => {
  // Ensure source and output directories exist
  if (!fs.existsSync(source)) {
    throw new Error(`Cannot find source directory ${source}`)
  }

  // Ensure index.graphql exists
  if (!fs.existsSync(`${source}/index.graphql`)) {
    throw new Error(`Cannot find index.graphql in ${source}`)
  }

  // Get the index.graphql file
  const file = path.join(source, 'index.graphql')
  const index = fs.readFileSync(file, 'utf8')

  // Parse
  let ast: DocumentNode = parse(
    `${EXPERIMENTAL_EXTENSIONS}${os.EOL}${options.extensions}${os.EOL}${index}`,
    {
      noLocation: true,
    },
  )

  // We make an exception for 'no type Query' or 'no type Mutation'
  ast = ensureQueryAndMutationTypes(ast)

  // Build and print, to validate
  buildASTSchema(ast)
  print(ast)

  // Custom validators
  for (const validator of validators) {
    validator(ast, source)
  }

  // Return true
  return true
}
