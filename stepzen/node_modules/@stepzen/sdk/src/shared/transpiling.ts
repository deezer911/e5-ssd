// Copyright (c) 2020,2021,2022, StepZen, Inc.

import * as dotenv from 'dotenv'
import * as fs from 'fs-extra'
import * as os from 'os'
import * as path from 'path'

const {transpile} = require('@stepzen/transpiler')

export const transpileConfigurationset = async (
  file: string | undefined,
): Promise<string | undefined> => {
  if (!file) {
    return
  }

  const source = file.substring(0, file.lastIndexOf('/'))
  dotenv.config({path: path.resolve(source, '.env')})

  const tmp = path.join(os.tmpdir(), `stepzen-transpiler-${Date.now()}`)
  const configPath = path.join(tmp, 'config.yaml')

  fs.ensureDirSync(tmp)
  fs.copyFileSync(file, configPath)

  const result = await transpile(tmp)

  if (result.transpiled) {
    fs.emptyDirSync(tmp)
    fs.writeFileSync(configPath, result.config)
    return configPath
  }

  fs.removeSync(tmp)
  return
}
