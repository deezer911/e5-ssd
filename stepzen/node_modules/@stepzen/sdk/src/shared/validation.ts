// Copyright (c) 2020,2021,2022, StepZen, Inc.

import * as fs from 'fs'
import * as glob from 'glob'
import * as yaml from 'yaml'

// Validate the Configurationset file
export const validateConfigurationset = async (file: string | undefined) => {
  if (!file) {
    throw new Error('You must provide a file path')
  }

  if (!fs.existsSync(file)) {
    throw new Error('The file does not exist')
  }

  const content = fs.readFileSync(file, 'utf8')

  // Ensure the file is valid YAML
  try {
    yaml.parse(content)
  } catch {
    throw new Error('The file is not valid YAML')
  }
}

// Validate the Schema directory
export const validateSchema = async (directory: string | undefined) => {
  if (!directory) {
    throw new Error('You must provide a directory path')
  }

  if (!fs.existsSync(directory)) {
    throw new Error('The directory does not exist')
  }

  // Ensure there's a root `index.graphql` file
  const allSchemaFiles = glob.sync('index.graphql', {cwd: directory})
  if (allSchemaFiles.length === 0) {
    throw new Error('Schemas must include an `index.graphql` file')
  }
}
