// Copyright (c) 2020,2021,2022, StepZen, Inc.

import * as debug from 'debug'
import fetch from 'node-fetch'

import {ADMIN_LIST_URL} from '../shared/constants'
import {getRequestHeaders} from '../shared/request'
import {
  SDKConfiguration,
  StepZenAccount,
  StepZenList,
  ZenCtlResponse,
} from '../shared/types'

export default async (
  details: StepZenList,
  account: StepZenAccount,
  sdkConfig: SDKConfiguration,
): Promise<ZenCtlResponse> => {
  const headers = getRequestHeaders(account, sdkConfig)

  debug('stepzen:headers')(headers)

  const response = await fetch(
    `${account.server}${ADMIN_LIST_URL}/${details.type}`,
    {
      headers: headers as any,
      method: 'GET',
    },
  )

  debug('stepzen:response')(response)

  if (response.status >= 400 && response.status < 500) {
    throw new Error(
      'Could not complete the request. Please check your authentication details are correct.',
    )
  }

  const text = await response.text()
  let json

  try {
    json = JSON.parse(text)
  } catch {
    throw new Error(`An unexpected error occurred.\n\n${text}`)
  }

  return json
}
